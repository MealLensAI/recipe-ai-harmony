<!DOCTYPE html>
<html>

<head>
    <title>Payment Debug Test</title>
    <script src="https://js.paystack.co/v1/inline.js"></script>
</head>

<body>
    <h1>Payment Debug Test</h1>
    <button onclick="testPayment()">Test Payment</button>

    <script>
        function testPayment() {
            console.log('🧪 Starting payment test...');

            // Simulate the payment callback
            const mockResponse = {
                reference: 'test_ref_12345',
                transaction_id: 'test_txn_67890',
                status: 'success'
            };

            console.log('✅ Payment successful:', mockResponse);
            console.log('🔍 Payment callback executed - starting backend call process...');

            // Test the backend call
            testBackendCall(mockResponse);
        }

        async function testBackendCall(response) {
            try {
                console.log('🔄 Testing backend call...');

                // Get user data (simulate what the real app does)
                const userData = localStorage.getItem('user_data');
                const supabaseUserId = localStorage.getItem('supabase_user_id');
                let userId = 'anonymous';

                if (userData) {
                    try {
                        const user = JSON.parse(userData);
                        userId = user.uid || user.id || supabaseUserId || 'anonymous';
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }

                console.log('👤 User ID:', userId);
                console.log('🔍 User data from localStorage:', userData);
                console.log('🔍 Supabase user ID:', supabaseUserId);

                // Check if user ID is in UUID format
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                const isValidUuid = uuidRegex.test(userId);
                console.log('🔍 Is valid UUID:', isValidUuid);

                if (!isValidUuid && userId !== 'anonymous') {
                    console.error('❌ User ID is not in UUID format! This will cause backend errors.');
                    alert('Error: Invalid user ID format. Please log out and log back in.');
                    return;
                }

                // Test data
                const testData = {
                    user_id: userId,
                    email: 'test@example.com',
                    plan_name: '$2.5 / 1 minute (test)',
                    plan_duration_days: 1,
                    paystack_data: {
                        reference: response.reference,
                        transaction_id: response.transaction_id,
                        amount: 2.5,
                        plan: '$2.5 / 1 minute (test)',
                        status: response.status
                    }
                };

                console.log('📤 Making fetch request to: /api/payment/success');
                console.log('📊 Request data:', testData);

                const backendResponse = await fetch('/api/payment/success', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                console.log('📥 Backend response status:', backendResponse.status);
                console.log('📥 Backend response headers:', Object.fromEntries(backendResponse.headers.entries()));

                if (backendResponse.ok) {
                    const result = await backendResponse.json();
                    console.log('✅ Backend response:', result);
                    alert('Backend call successful! Check console for details.');
                } else {
                    console.error('❌ Backend request failed:', backendResponse.status);
                    const errorText = await backendResponse.text();
                    console.error('❌ Error response:', errorText);
                    alert('Backend call failed! Check console for details.');
                }

            } catch (error) {
                console.error('❌ Error calling backend:', error);
                console.error('❌ Error details:', error);
                console.error('❌ Error stack:', error.stack);
                alert('Error calling backend! Check console for details.');
            }
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html>

<head>
    <title>Paystack Callback Test</title>
    <script src="https://js.paystack.co/v1/inline.js"></script>
</head>

<body>
    <h1>Paystack Callback Test</h1>
    <button onclick="testPaystackCallback()">Test Paystack Callback</button>
    <div id="logs"></div>

    <script>
        function log(message) {
            console.log(message);
            document.getElementById('logs').innerHTML += '<div>' + message + '</div>';
        }

        function testPaystackCallback() {
            log('🧪 Starting Paystack callback test...');

            // Check if PaystackPop is available
            if (typeof window.PaystackPop === 'undefined') {
                log('❌ PaystackPop is not available');
                return;
            }

            log('✅ PaystackPop is available');

            // Test the callback function directly
            log('🔧 Testing callback function...');

            const testResponse = {
                reference: 'test_ref_12345',
                transaction_id: 'test_txn_67890',
                status: 'success'
            };

            // Simulate the callback
            log('🎉 Simulating Paystack callback...');
            simulateCallback(testResponse);
        }

        function simulateCallback(response) {
            log('🎉 PAYSTACK CALLBACK TRIGGERED!');
            log('✅ Payment successful: ' + JSON.stringify(response));
            log('🔍 Payment callback executed - starting backend call process...');

            // Test the backend call
            testBackendCall(response);
        }

        async function testBackendCall(response) {
            try {
                log('🔄 Testing backend call...');

                const testData = {
                    user_id: 'cd9d8fed-6e82-4831-9890-99c87a2eb8cc',
                    email: 'test@example.com',
                    plan_name: '$2.5 / 1 minute (test)',
                    plan_duration_days: 1,
                    paystack_data: {
                        reference: response.reference,
                        transaction_id: response.transaction_id,
                        amount: 2.5,
                        plan: '$2.5 / 1 minute (test)',
                        status: response.status
                    }
                };

                log('📤 Making fetch request to: /api/payment/success');

                const backendResponse = await fetch('/api/payment/success', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                log('📥 Backend response status: ' + backendResponse.status);

                if (backendResponse.ok) {
                    const result = await backendResponse.json();
                    log('✅ Backend response: ' + JSON.stringify(result));
                    log('✅ Backend call successful!');
                } else {
                    log('❌ Backend request failed: ' + backendResponse.status);
                }

            } catch (error) {
                log('❌ Error calling backend: ' + error.message);
            }
        }
    </script>
</body>

</html>